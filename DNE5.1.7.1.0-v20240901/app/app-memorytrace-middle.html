<!DOCTYPE html>
<!-- 言語は英語、全体の高さを100%にし、余白なし、タッチ操作を無効化 -->
<html lang="en" style="height:100%;margin:0;touch-action:none;">
<head>
    <!-- 文字エンコーディングをUTF-8に設定 -->
    <meta charset="UTF-8">
    <!-- モバイルデバイス対応の設定（レスポンシブデザイン） -->
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <!-- 必要なJavaScriptファイルを読み込み -->
    <script type="text/javascript" src="../fixed_info.js"></script>
    <script type="text/javascript" src="../connection.js"></script>
    <script type="text/javascript" src="../paho-mqtt-min.js"></script>
    <script type="text/javascript" src="../client_dne_lib.js"></script>
    <!-- CSSファイルを読み込み -->
    <link rel="stylesheet" href="../default.css">
    <title>Connecting...</title>
    
    <script>
        // 関数定義
        // ブローカに接続時に実行される 
        function onConnected(){
            // type_and_serialはサウザーのシリアル番号
            subscribe("0/WHISPERER/" + type_and_serial + "/io12");
            subscribe("0/WHISPERER/" + type_and_serial + "/app_status");
            subscribe("0/THOUZER_HW/" + type_and_serial + "/event/app");
            subscribe("0/THOUZER_HW/" + type_and_serial + "/indicator/app");
            pos_t_update("---", "---");
        }
        // MQTTでmsgを受け取った後に、受け取ったmsgをもとに処理が分岐する
        function subscribeParsed(topic, json){
            if(topic == "0/WHISPERER/" + type_and_serial + "/app_status" && json.MT_suspend != null && json.app != null && json.MT_teach != null){
                // メモリトレース走行中
                if(json.app.indexOf("./bin/app-memorytrace") == 0){
                    // getElementById: 特定の要素を探す
                    // document: documentオブジェクト、ブラウザが読み込んだウェブページのモデルを表し、ページの内容や構造にアクセスするためのインターフェース
                    // memorize_t, play_t ..etc : HTML内の表示テキストを動的に変更するための要素ID
                    document.getElementById("memorize_t").innerText = "Stop and Cancel";
                    document.getElementById("play_t").innerText = "Playback Stop";
                    // setAttribute(属性の名前, 新しい属性名), onclickにstop()の機能を付与する
                    document.getElementById("play").setAttribute("onclick", "stop()");
                }else{
                // メモリトレース走行中ではないとき
                    document.getElementById("memorize_t").innerText = "Memorize (IO76)";
                    document.getElementById("play_t").innerText = "Play (IO76)";
                    document.getElementById("play").setAttribute("onclick", "play()");
                }
                // メモリトレースの記憶中
                if(json.MT_teach) document.getElementById("memorize_t").innerText = "Memorize Save";
                // メモリトレース中断中
                if(json.MT_suspend){
                    document.getElementById("memorize_t").innerText = "Cancel Resume";
                    document.getElementById("play_t").innerText = "Play Resume";
                }
                // メモリトレース記憶中、中断ではなく、また、
                // indexOf: 指定した文字列がどの位置に現れるかを返す。
                if(json.app.indexOf("./bin/app-memorytrace") != 0 && !json.MT_teach && !json.MT_suspend){
                    // style.displayで表示、非表示を切り替える
                    document.getElementById("pos_t").style.display = 'none';
                    document.getElementById("map").style.display = 'block';
                    document.getElementById("select").style.display = 'block';
                }else{
                    document.getElementById("map").style.display = 'none';
                    document.getElementById("select").style.display = 'none';
                    if(document.getElementById("pos_t").style.display == 'none') pos_t_update("---", "---");
                    document.getElementById("pos_t").style.display = 'block';
                }
            }
            if(topic == "0/THOUZER_HW/" + type_and_serial + "/event/app" && json.data != null && json.data.application != null && (json.data.application == "memorytrace" || json.data.application == "memorytraceTeach")){ 
                if(json.data.map != null && json.data.pos != null) pos_t_update(json.data.map, json.data.pos);
            }
        }
        // ボタンが押されたときに呼ばれる関数
        function play(){ 
            // IO76でメモリトレースの走行を開始する
            publishCmdParam('app-memorytrace', '--map IO76'); 
            // 走行中の進捗状況を更新する関数を呼び出す
            pos_t_update(map, pos);
        }
        function loop(){ publishCmdParam('app-memorytrace', '--map IO76 --loop'); }
        // メモリトレースを停止する
        function stop(){ publishCmd(''); }
        // 走行中の進捗状況を更新する
        function pos_t_update(m, p) {
            // innerHTML: HTML要素に値を追加する
            document.getElementById("pos_t").innerHTML = "<div style='height:100%;width:100%;float:left;position:relative;'><span class='text'>map : " + m + " / pos : " + p + "</span></div>";
        }
    </script>
</head>

<!-- ページが表示されると同時に初期設定や接続処理（MQTTサーバーへの接続など）が実行される -->
<body class="content" onload="tryConnectFirst();" ontouchstart="">
<div id="status" class="area" style="height:8%;font-size:6vmin;font-size:6dvmin;">Connecting...</div>

<div class="area" style="height:30%;font-size:10vmin;font-size:10dvmin;"><div class="button" id="memorize" onclick="publishCmdParam('memory-start-save', '--map IO76')"><span class="text" id="memorize_t">Memorize (IO76)</span></div></div>
<div class="area" style="height:30%;font-size:10vmin;font-size:10dvmin;"><div class="button" id="play" onclick="play()"><span class="text" id="play_t">Play (IO76)</span></div></div>


<div class="area" style="height:30%;font-size:10vmin;font-size:10dvmin;" id="pos_t"></div>

<input id="map" type="text" style="height:12%;font-size:8vmin;font-size:8dvmin;width:calc(100% - 75px);box-sizing:border-box;float:left;" value="IO76">
<select style="height:12%;font-size:6vmin;font-size:6dvmin;width:40px;box-sizing:border-box;float:left;" id="select" onchange="select();">
  <option value=""></option>
  <option value="IO76">IO76</option>
  <option value="B101">B101</option>
  <option value="B102">B102</option>
  <option value="B103">B103</option>
  <option value="B104">B104</option>
  <option value="B105">B105</option>
  <option value="B106">B106</option>
  <option value="B107">B107</option>
  <option value="B201">B201</option>
  <option value="B202">B202</option>
  <option value="B203">B203</option>
  <option value="B204">B204</option>
  <option value="B205">B205</option>
  <option value="B206">B206</option>
  <option value="B207">B207</option>
</select>
</html>